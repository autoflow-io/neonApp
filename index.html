<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeonApp - TikTok OAuth 2.0 Login</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
            padding: 40px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            font-size: 48px;
            margin-bottom: 15px;
        }

        h1 {
            font-size: 28px;
            color: #1a1a1a;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
        }

        /* Security Message Section */
        .security-banner {
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 25px;
            border-radius: 6px;
            font-size: 13px;
            color: #333;
        }

        .security-banner h3 {
            font-size: 13px;
            color: #667eea;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .security-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            margin-right: 4px;
        }

        .oauth-info {
            background: #fff9e6;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-bottom: 25px;
            border-radius: 6px;
            font-size: 13px;
            color: #333;
        }

        .oauth-info h3 {
            font-size: 13px;
            color: #ff6b35;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .oauth-flow-details {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 4px;
            margin-top: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
        }

        .oauth-flow-details li {
            margin-left: 20px;
            margin-bottom: 4px;
        }

        /* Login Button */
        .login-section {
            margin-bottom: 25px;
        }

        .tiktok-login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #25f4ee 0%, #ff006e 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(255, 0, 110, 0.3);
        }

        .tiktok-login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 0, 110, 0.4);
        }

        .tiktok-login-btn:active {
            transform: translateY(0);
        }

        .tiktok-login-btn svg {
            width: 20px;
            height: 20px;
        }

        /* OAuth Redirect Confirmation */
        .oauth-confirmation {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            display: none;
            animation: slideIn 0.3s ease;
        }

        .oauth-confirmation.visible {
            display: block;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .oauth-confirmation h3 {
            color: #2e7d32;
            margin-bottom: 8px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .oauth-confirmation p {
            color: #1b5e20;
            font-size: 13px;
            margin-bottom: 10px;
        }

        .confirmation-details {
            background: rgba(76, 175, 80, 0.1);
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            color: #1b5e20;
            font-family: 'Courier New', monospace;
        }

        /* Loading State */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .environment-badge {
            display: inline-block;
            background: #fff3cd;
            color: #856404;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 15px;
        }

        .consent-notice {
            background: #f0f0f0;
            padding: 12px;
            border-radius: 6px;
            font-size: 12px;
            color: #555;
            margin-top: 15px;
            line-height: 1.6;
        }

        .consent-notice strong {
            color: #333;
        }

        .footer-links {
            text-align: center;
            margin-top: 20px;
            font-size: 12px;
        }

        .footer-links a {
            color: #667eea;
            text-decoration: none;
            margin: 0 10px;
        }

        .footer-links a:hover {
            text-decoration: underline;
        }

        .status-message {
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
            font-size: 13px;
            display: none;
        }

        .status-message.error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
            display: block;
        }

        .status-message.success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üéµ</div>
            <h1>NeonApp</h1>
            <p class="subtitle">Connect with TikTok via OAuth 2.0</p>
        </div>

        <!-- OAuth 2.0 Security Information -->
        <div class="security-banner">
            <h3>
                <span>üîí</span>
                <span class="security-badge">OAuth 2.0</span> Secure Authentication
            </h3>
            <p>
                This application uses the official <strong>TikTok Login Kit</strong> with OAuth 2.0 protocol. 
                Your login credentials are verified by TikTok's secure servers. We never see your password.
            </p>
        </div>

        <!-- OAuth Flow Information -->
        <div class="oauth-info">
            <h3>
                <span>‚ÑπÔ∏è</span> How OAuth 2.0 Works
            </h3>
            <ol class="oauth-flow-details">
                <li><strong>Authorization Request:</strong> You'll be redirected to TikTok's login page</li>
                <li><strong>User Consent:</strong> Review and approve the permissions requested</li>
                <li><strong>Authorization Code:</strong> TikTok generates a secure code</li>
                <li><strong>Token Exchange:</strong> Code is securely exchanged for an access token</li>
                <li><strong>Account Access:</strong> App accesses your profile with granted permissions</li>
            </ol>
        </div>

        <!-- Login Section -->
        <div class="login-section">
            <button class="tiktok-login-btn" id="tiktokLoginBtn" onclick="initiateOAuthFlow()">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.1 1.75 2.9 2.9 0 0 1 2.31-4.64 2.88 2.88 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-3.47v-3.5a8.26 8.26 0 0 0 3.77 1.23V9.45a4.9 4.9 0 0 1-.49-.05z"/>
                </svg>
                <span>Login with TikTok</span>
            </button>
        </div>

        <!-- Loading State -->
        <div class="loading" id="loadingState">
            <div class="spinner"></div>
            <p>Redirecting to TikTok authorization...</p>
        </div>

        <!-- OAuth Redirect Confirmation -->
        <div class="oauth-confirmation" id="oauthConfirmation">
            <h3>
                <span>‚úì</span> OAuth Authorization Initiated
            </h3>
            <p><strong>You are being redirected to TikTok's authorization server.</strong></p>
            <div class="confirmation-details">
                <div><strong>Protocol:</strong> OAuth 2.0 Authorization Code Flow</div>
                <div><strong>Client ID:</strong> <code>sandbox_7f5e9c3a2b</code></div>
                <div><strong>Timestamp:</strong> <span id="timestamp"></span></div>
                <div><strong>Redirect URI:</strong> <code>https://app.neonapp.io/callback</code></div>
                <div><strong>Scope:</strong> user.info.basic, user.info.profile</div>
            </div>
            <p style="margin-top: 10px; font-size: 12px;">
                If you are not redirected within 3 seconds, <a href="#" onclick="window.location.reload(); return false;" style="color: #2e7d32; text-decoration: underline;">click here</a>.
            </p>
        </div>

        <!-- User Consent Notice -->
        <div class="consent-notice">
            <strong>‚ö†Ô∏è User Consent & Transparency:</strong><br>
            By clicking "Login with TikTok", you agree to:
            <ul style="margin-left: 15px; margin-top: 5px;">
                <li>Be redirected to TikTok's official login page</li>
                <li>Share your basic profile information (name, username, profile picture)</li>
                <li>Review TikTok's <a href="https://www.tiktok.com/privacy" target="_blank" style="color: #667eea;">Privacy Policy</a> and <a href="https://www.tiktok.com/legal/page/us/terms-of-service" target="_blank" style="color: #667eea;">Terms of Service</a></li>
                <li>This is a <span class="environment-badge">SANDBOX</span> demo environment</li>
            </ul>
        </div>

        <!-- Status Message -->
        <div class="status-message" id="statusMessage"></div>

        <!-- Footer Links -->
        <div class="footer-links">
            <a href="https://developers.tiktok.com/doc/login-kit" target="_blank">TikTok Dev Docs</a>
            <a href="https://tools.ietf.org/html/rfc6749" target="_blank">OAuth 2.0 Spec</a>
        </div>
    </div>

    <script>
        // OAuth 2.0 Configuration (Sandbox Credentials)
        const OAUTH_CONFIG = {
            clientId: 'sandbox_7f5e9c3a2b',
            redirectUri: 'https://app.neonapp.io/callback',
            authorizationEndpoint: 'https://www.tiktok.com/oauth/authorize',
            tokenEndpoint: 'https://open.tiktokapis.com/v2/oauth/token/',
            scopes: ['user.info.basic', 'user.info.profile'],
            state: generateRandomState(),
            codeChallenge: generatePKCEChallenge(),
        };

        /**
         * Generate a random state value for CSRF protection
         */
        function generateRandomState() {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
            let state = '';
            for (let i = 0; i < 64; i++) {
                state += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return state;
        }

        /**
         * Generate PKCE Challenge for additional security
         */
        function generatePKCEChallenge() {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
            let codeVerifier = '';
            for (let i = 0; i < 128; i++) {
                codeVerifier += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            // Store for later verification
            sessionStorage.setItem('pkce_verifier', codeVerifier);
            return codeVerifier;
        }

        /**
         * Initiate OAuth 2.0 Authorization Code Flow
         */
        function initiateOAuthFlow() {
            try {
                // Store OAuth state for verification
                sessionStorage.setItem('oauth_state', OAUTH_CONFIG.state);
                sessionStorage.setItem('oauth_timestamp', new Date().toISOString());

                // Build authorization URL
                const authUrl = new URL(OAUTH_CONFIG.authorizationEndpoint);
                authUrl.searchParams.append('client_id', OAUTH_CONFIG.clientId);
                authUrl.searchParams.append('redirect_uri', OAUTH_CONFIG.redirectUri);
                authUrl.searchParams.append('response_type', 'code');
                authUrl.searchParams.append('scope', OAUTH_CONFIG.scopes.join(','));
                authUrl.searchParams.append('state', OAUTH_CONFIG.state);
                authUrl.searchParams.append('code_challenge', OAUTH_CONFIG.codeChallenge);
                authUrl.searchParams.append('code_challenge_method', 'plain');

                // Show loading state
                showLoadingState();

                // Show OAuth confirmation with visible details
                showOAuthConfirmation();

                // Log the OAuth flow initiation
                console.log('üîê OAuth 2.0 Authorization Code Flow Initiated');
                console.log('Authorization Endpoint:', OAUTH_CONFIG.authorizationEndpoint);
                console.log('Client ID:', OAUTH_CONFIG.clientId);
                console.log('Redirect URI:', OAUTH_CONFIG.redirectUri);
                console.log('Requested Scopes:', OAUTH_CONFIG.scopes);
                console.log('State:', OAUTH_CONFIG.state);
                console.log('Authorization URL:', authUrl.toString());

                // Redirect to TikTok authorization after a brief delay for visibility
                setTimeout(() => {
                    window.location.href = authUrl.toString();
                }, 1500);

            } catch (error) {
                console.error('OAuth Flow Error:', error);
                showError('Failed to initiate OAuth flow. Please try again.');
            }
        }

        /**
         * Handle OAuth Redirect Callback (for when user returns from TikTok)
         */
        function handleOAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const error = urlParams.get('error');
            const errorDescription = urlParams.get('error_description');

            if (error) {
                console.error('OAuth Error:', error, errorDescription);
                showError(`Authorization failed: ${errorDescription || error}`);
                return;
            }

            if (code) {
                // Verify state for CSRF protection
                const storedState = sessionStorage.getItem('oauth_state');
                if (state !== storedState) {
                    console.error('State mismatch - potential CSRF attack');
                    showError('Security validation failed. Please try again.');
                    return;
                }

                console.log('‚úì Authorization code received:', code);
                console.log('‚úì State verification passed');

                // In a real application, exchange the code for a token
                // This would be done on the backend server
                exchangeCodeForToken(code);
            }
        }

        /**
         * Exchange authorization code for access token (Backend Operation)
         */
        function exchangeCodeForToken(authCode) {
            console.log('üîÑ Exchanging authorization code for access token...');

            // In production, this should be done on your backend
            const tokenRequest = {
                client_id: OAUTH_CONFIG.clientId,
                client_secret: '{{BACKEND_CLIENT_SECRET}}', // Never expose in frontend
                code: authCode,
                grant_type: 'authorization_code',
                redirect_uri: OAUTH_CONFIG.redirectUri,
            };

            console.log('Token Request Payload (sanitized):', {
                client_id: tokenRequest.client_id,
                grant_type: tokenRequest.grant_type,
                redirect_uri: tokenRequest.redirect_uri,
                code: '***REDACTED***'
            });

            // Simulated token exchange response
            setTimeout(() => {
                showSuccess('‚úì Successfully authenticated with TikTok! Access token obtained and stored securely.');
                console.log('‚úì OAuth 2.0 flow completed successfully');
            }, 1000);
        }

        /**
         * Display loading state
         */
        function showLoadingState() {
            const loadingElement = document.getElementById('loadingState');
            if (loadingElement) {
                loadingElement.classList.add('active');
                document.getElementById('tiktokLoginBtn').disabled = true;
            }
        }

        /**
         * Hide loading state
         */
        function hideLoadingState() {
            const loadingElement = document.getElementById('loadingState');
            if (loadingElement) {
                loadingElement.classList.remove('active');
                document.getElementById('tiktokLoginBtn').disabled = false;
            }
        }

        /**
         * Show OAuth confirmation with visible details
         */
        function showOAuthConfirmation() {
            const confirmationElement = document.getElementById('oauthConfirmation');
            if (confirmationElement) {
                document.getElementById('timestamp').textContent = new Date().toISOString();
                confirmationElement.classList.add('visible');
            }
        }

        /**
         * Show error message
         */
        function showError(message) {
            hideLoadingState();
            const statusElement = document.getElementById('statusMessage');
            if (statusElement) {
                statusElement.textContent = '‚ùå ' + message;
                statusElement.classList.remove('success');
                statusElement.classList.add('error');
            }
        }

        /**
         * Show success message
         */
        function showSuccess(message) {
            hideLoadingState();
            const statusElement = document.getElementById('statusMessage');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.classList.remove('error');
                statusElement.classList.add('success');
            }
        }

        /**
         * Initialize the application
         */
        function initializeApp() {
            // Check if we're returning from OAuth redirect
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('code') || urlParams.has('error')) {
                handleOAuthCallback();
            }

            // Log application initialization
            console.log('üöÄ NeonApp initialized');
            console.log('üì± TikTok OAuth 2.0 Login Kit enabled');
            console.log('üîí Security: OAuth 2.0 with PKCE and CSRF protection');
            console.log('üìã Environment: Sandbox (sandbox_7f5e9c3a2b)');
        }

        // Initialize app when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
</body>
</html>